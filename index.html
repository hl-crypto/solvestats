<script>
    const events = {
        "333": "3x3", "222": "2x2", "444": "4x4", "555": "5x5", "666": "6x6", "777": "777",
        "333oh": "3x3 OH", "333bf": "3x3 BLD", "minx": "Megaminx", "pyram": "Pyraminx",
        "clock": "Clock", "skewb": "Skewb", "sq1": "Square-1", "444bf": "4x4 BLD", "555bf": "5x5 BLD"
    };

    let solveChart;
    let allData = {};

    const grid = document.getElementById('pb-grid');
    Object.keys(events).forEach(key => {
        grid.innerHTML += `
            <div class="pb-card" onclick="showGraph('${key}')" style="cursor:pointer">
                <h3>${events[key]}</h3>
                <div class="time" id="${key}-single">--.--</div>
                <div class="avg-info">PB Ao5: <span id="${key}-ao5">--.--</span></div>
            </div>
        `;
    });

    document.getElementById('fileInput').addEventListener('change', function(e) {
        const file = e.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function(event) {
            try {
                const data = JSON.parse(event.target.result);
                allData = {}; // Nullstill gammel data

                // Finn session-data (kan ligge direkte eller under 'properties')
                let sessionMeta = {};
                if (data.properties) {
                    const props = typeof data.properties === 'string' ? JSON.parse(data.properties) : data.properties;
                    sessionMeta = JSON.parse(props.sessionData || "{}");
                }

                // Gå gjennom alle sessions i filen
                Object.keys(data).forEach(key => {
                    if (key.startsWith('session')) {
                        const sessionId = key.replace('session', '');
                        const scrambleType = sessionMeta[sessionId] ? sessionMeta[sessionId].opt.scrType : "333";
                        
                        // Hent ut tider fra csTimer-format: [ [ [tid_i_ms, ...], ... ] ]
                        const sessionSolves = data[key];
                        if (Array.isArray(sessionSolves)) {
                            const times = sessionSolves
                                .map(s => (Array.isArray(s) && s[0] ? s[0][0] / 1000 : null))
                                .filter(t => t !== null && t > 0);

                            if (times.length > 0) {
                                const eventKey = events[scrambleType] ? scrambleType : "333";
                                if (!allData[eventKey]) allData[eventKey] = [];
                                allData[eventKey] = allData[eventKey].concat(times);
                            }
                        }
                    }
                });

                updateDashboard();
            } catch (err) {
                console.error("Feil ved lesing:", err);
                alert("Kunne ikke lese filen. Sjekk at du har eksportert 'Server format' eller 'File' fra csTimer.");
            }
        };
        reader.readAsText(file);
    });

    function updateDashboard() {
        Object.keys(allData).forEach(key => {
            const times = allData[key];
            if (times.length === 0) return;

            const single = Math.min(...times).toFixed(2);
            document.getElementById(`${key}-single`).innerText = single + "s";

            let bestAo5 = Infinity;
            for (let i = 0; i <= times.length - 5; i++) {
                const current5 = times.slice(i, i + 5).sort((a, b) => a - b);
                const ao5 = (current5[1] + current5[2] + current5[3]) / 3; // Fjerner best og dårligst
                if (ao5 < bestAo5) bestAo5 = ao5;
            }
            
            if (bestAo5 !== Infinity) {
                document.getElementById(`${key}-ao5`).innerText = bestAo5.toFixed(2) + "s";
            }
        });
        if (allData["333"]) showGraph("333");
    }

    function showGraph(key) {
        const times = allData[key];
        if (!times) return;

        document.getElementById('chart-title').innerText = `Fremgang: ${events[key]}`;
        const ctx = document.getElementById('solveChart').getContext('2d');
        if (solveChart) solveChart.destroy();

        solveChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: times.map((_, i) => i + 1),
                datasets: [{
                    label: 'Sekunder',
                    data: times,
                    borderColor: '#3498db',
                    borderWidth: 2,
                    pointRadius: 1,
                    fill: true,
                    backgroundColor: 'rgba(52, 152, 219, 0.1)',
                    tension: 0.1
                }]
            },
            options: {
                responsive: true,
                scales: {
                    y: { grid: { color: '#333' } },
                    x: { display: false }
                }
            }
        });
    }
</script>
